<!-- Begin Page Content -->
<div class="container-fluid">

    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800"><%= title %></h1>
        <a href="/admin/orders" class="btn btn-outline-primary btn-sm">Orders</a>
    </div>

    <div class="row">

        <!-- LEFT: ORDER & CUSTOMER INFO -->
        <div class="col-lg-7 mb-4">
            <div class="bg-light p-3 shadow-sm">

                <h6 class="text-primary mb-3">Order Information</h6>

                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th>Order Number</th>
                            <td><%= order.orderNumber %></td>
                        </tr>
                        <tr>
                            <th>Order Date</th>
                            <td><%= new Date(order.createdAt).toDateString() %></td>
                        </tr>
                        <tr>
                            <th>Customer</th>
                            <td><%= order.userId.name %> (<%= order.userId.email %>)</td>
                        </tr>
                        <tr>
                            <th>Payment</th>
                            <td>
                                <%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online' %>
                                |
                                <%
                                    let paymentBadge = 'secondary';

                                    if (order.paymentStatus === 'pending') paymentBadge = 'warning';
                                    if (order.paymentStatus === 'paid') paymentBadge = 'success';
                                    if (order.paymentStatus === 'failed') paymentBadge = 'danger';
                                    if (order.paymentStatus === 'refunded') paymentBadge = 'info';
                                %>

                                <span class="badge badge-<%= paymentBadge %> text-uppercase px-3 py-2">
                                    <%= order.paymentStatus %>
                                </span>

                            </td>
                        </tr>
                        <tr>
                            <th>Overall Status</th>
                            <td>
                                <%
                                let statusBadge = 'secondary';

                                if (order.overallStatus === 'pending') statusBadge = 'warning';
                                if (order.overallStatus === 'partially_completed') statusBadge = 'info';
                                if (order.overallStatus === 'completed') statusBadge = 'success';
                                if (order.overallStatus === 'cancelled') statusBadge = 'danger';
                            %>

                            <span class="badge badge-<%= statusBadge %> text-uppercase px-3 py-2">
                                <%= order.overallStatus.replace('_', ' ') %>
                            </span>

                            </td>
                        </tr>
                    </tbody>
                </table>

                <hr>

                <h6 class="text-primary">Shipping Address</h6>
                <p class="mb-0">
                    <%= order.shippingAddress.line1 %><br>
                    <%= order.shippingAddress.city %>,
                    <%= order.shippingAddress.state %><br>
                    <%= order.shippingAddress.country %> - <%= order.shippingAddress.postalCode %>
                </p>
            </div>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="col-lg-5 mb-4">
            <div class="bg-light p-3 shadow-sm">
                <h6 class="text-primary mb-3">Order Summary</h6>

                <div class="d-flex justify-content-between">
                    <span>Total Quantity</span>
                    <strong><%= order.totalQuantity %></strong>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <span>Total Price</span>
                    <strong>$<%= order.totalPrice.toFixed(2) %></strong>
                </div>
            </div>
            <% if(order.overallStatus == 'pending' || order.overallStatus == 'partially_completed') { %>
            <a class="btn btn-block btn-outline-danger mt-2" data-toggle="modal" data-target="#adminCancelOrderModal">Cancel Order</a>
            <% } %>
        </div>

    </div>

    <!-- VENDOR BREAKDOWN -->
    <div class="row mt-4">
        <div class="col-12">
            <h5 class="text-gray-800 mb-3">Vendor Orders</h5>

            <% vendorOrders.forEach(vendorOrder => { %>
                <div class="bg-light p-3 shadow-sm mb-4">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>
                            Vendor: <%= vendorOrder.vendorId.name %>
                        </strong>
                        <%
                            let vendorBadge = 'secondary';

                            if (vendorOrder.vendorStatus === 'pending') vendorBadge = 'warning';
                            if (vendorOrder.vendorStatus === 'accepted') vendorBadge = 'info';
                            if (vendorOrder.vendorStatus === 'shipped') vendorBadge = 'primary';
                            if (vendorOrder.vendorStatus === 'delivered') vendorBadge = 'success';
                            if (vendorOrder.vendorStatus === 'cancelled') vendorBadge = 'danger';
                        %>

                        <span class="badge badge-<%= vendorBadge %> text-uppercase px-3 py-2">
                            <%= vendorOrder.vendorStatus %>
                        </span>

                    </div>

                    <table class="table table-sm table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>Product</th>
                                <th>Shop</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% vendorOrder.items.forEach(item => { %>
                                <tr>
                                    <td><%= item.name %></td>
                                    <td><%= item.shopId.name %></td>
                                    <td><%= item.quantity %></td>
                                    <td>$<%= item.price.toFixed(2) %></td>
                                    <td>$<%= item.subtotal.toFixed(2) %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>

                    <div class="d-flex justify-content-between mt-2">
                        <span>Vendor Subtotal</span>
                        <strong>$<%= vendorOrder.subtotal.toFixed(2) %></strong>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span>Commission</span>
                        <span>$<%= vendorOrder.commission.toFixed(2) %></span>
                    </div>

                    <div class="d-flex justify-content-between font-weight-bold">
                        <span>Vendor Earning</span>
                        <span>$<%= vendorOrder.vendorEarning.toFixed(2) %></span>
                    </div>

                </div>
            <% }) %>
        </div>
    </div>

</div>

<%- include('../../partials/adminCancelOrderModal') %>