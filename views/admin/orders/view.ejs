<!-- Begin Page Content -->
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800"><%= title %></h1>
        <div class="ml-auto">
          <a href="/vendor/orders" class="btn btn-outline-primary btn-sm mt-1">Orders</a>
        </div>
    </div>

</div>
<div class="container-fluid">
    <div class="row">

        <!-- LEFT: ORDER INFO -->
        <div class="col-lg-8 mb-4">
            <div class="bg-light p-3 shadow">

                <table class="table table-striped">
                    <tbody>
                        <tr>
                            <th>Order Number</th>
                            <td><%= order.orderId.orderNumber %></td>
                        </tr>
                        <tr>
                            <th>Order Date</th>
                            <td><%= order.createdAt.toDateString() %></td>
                        </tr>
                        <tr>
                            <th>Vendor Status</th>
                            <td>
                                <% let badge = 'secondary'; %>
                                <% if (order.vendorStatus === 'pending') badge = 'warning'; %>
                                <% if (order.vendorStatus === 'accepted') badge = 'info'; %>
                                <% if (order.vendorStatus === 'shipped') badge = 'primary'; %>
                                <% if (order.vendorStatus === 'delivered') badge = 'success'; %>
                                <% if (order.vendorStatus === 'cancelled') badge = 'danger'; %>

                                <span class="badge badge-<%= badge %> text-uppercase px-3 py-2">
                                    <%= order.vendorStatus %>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th>Payment Method</th>
                            <td>
                                <%= order.orderId.paymentMethod === 'cod'
                                    ? 'Cash on Delivery'
                                    : 'Online Payment'
                                %>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Update Vendor Status Form -->
                <% if (!['cancelled', 'delivered'].includes(order.vendorStatus)) { %>
                    <form action="/vendor/orders/status/<%= order._id %>" method="POST" class="mt-3">
                        <div class="form-group">
                            <label><strong>Update Order Status</strong></label>
                            <select name="vendorStatus" class="form-control" required>
                                <option value="">Select status</option>
                                <% if (order.vendorStatus === 'pending') { %>
                                    <option value="accepted">Accept Order</option>
                                <% } %>
                                <% if (['accepted'].includes(order.vendorStatus)) { %>
                                    <option value="shipped">Mark as Shipped</option>
                                <% } %>
                                <% if (order.vendorStatus === 'shipped') { %>
                                    <option value="delivered">Mark as Delivered</option>
                                <% } %>
                                <option value="cancelled">Cancel Order</option>
                            </select>
                        </div>
                        <button class="btn btn-primary mt-2">Update Status</button>
                    </form>
                <% } %>
            </div>

            <div class="bg-light p-3 shadow my-4" style="max-height: 500px; overflow-y: scroll;">
                <!-- ============================= -->
                <!-- REVIEWS SECTION BELOW ORDER -->
                <!-- ============================= -->
                <h5 class="text-gray-800 mb-3"></i> Customer Reviews</h5>
                <hr>
                <% reviews.forEach(review => { %>
                <div class="media mb-4 border-bottom pb-1">
                    <img src="<%= (review.userId.profilePic) ? '/uploads/users/' + review.userId.profilePic : '/img/placeholder.png' %>" alt="User Image" class="img-fluid mr-3 mt-1" style="width: 45px;">
                    <div class="media-body">
                        <!-- User Name and Review Date -->
                        <h6>
                            <%= review.userId.name %> 
                            <small class="text-muted"> - <i><%= review.createdAt.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' }) %></i></small>
                        </h6>

                        <!-- Dynamic Star Rating -->
                        <div class="text-warning mb-2">
                            <% for(let i = 1; i <= 5; i++) { %>
                                <% if (i <= review.rating) { %>
                                    <i class="fas fa-star"></i>
                                <% } else { %>
                                    <i class="far fa-star"></i>
                                <% } %>
                            <% } %>
                        </div>

                        <!-- Review Comment -->
                        <p><%= review.comment %></p>

                        <!-- Vendor Reply (if exists) -->
                        <% if (review.vendorReply) { %>
                            <div class="ml-4 p-2 border-left border-primary">
                                <strong>Vendor Reply:</strong>
                                <p class="mb-0"><%= review.vendorReply %></p>
                            </div>
                        <% } %>
                    </div>
                </div>
                <% }) %>
            </div>



        </div>


        <!-- RIGHT: ITEMS BY SHOP -->
        <div class="col-lg-4">
            <div class="bg-light">

                <% itemsByShop.forEach(group => { %>

                    <div class="mb-3 p-3 shadow">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-store"></i>
                            <%= group.shop.name %>
                        </h6>

                        <% group.items.forEach(item => { %>
                            <div class="d-flex justify-content-between mb-1">
                                <span>
                                    <%= item.name %> Ã— <%= item.quantity %>
                                </span>
                                <span>
                                    $<%= item.subtotal.toFixed(2) %>
                                </span>
                            </div>
                        <% }) %>

                        <div class="d-flex justify-content-between mt-2 font-weight-bold">
                            <span>Shop Subtotal</span>
                            <span>$<%= group.subtotal.toFixed(2) %></span>
                        </div>
                    </div>

                <% }) %>
                
                <div class="p-3 mb-3 shadow">
                    <div class="d-flex justify-content-between">
                        <strong>Order Subtotal</strong>
                        <strong>$<%= order.subtotal.toFixed(2) %></strong>
                    </div>

                    <div class="d-flex justify-content-between mt-2">
                        <span>Commission</span>
                        <span>$<%= order.commission.toFixed(2) %></span>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-2 h5">
                    <strong>Your Earning</strong>
                    <small class="badge badge-<%= (order.vendorEarningStatus === 'paid' ? 'success' : 'danger') %> text-uppercase"><%= order.vendorEarningStatus %></small>
                    <strong class="text-success">
                        $<%= order.vendorEarning.toFixed(2) %>
                    </strong>
                </div>

            </div>
        </div>


    </div>
</div>
