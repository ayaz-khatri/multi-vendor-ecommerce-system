<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="/">Home</a>
                <a class="breadcrumb-item text-dark" href="/orders">Orders</a>
                <span class="breadcrumb-item active">Order Details</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->

<div class="container-fluid">
    <div class="row px-xl-5">

        <!-- LEFT: ORDER INFO -->
        <div class="col-lg-8 mb-4">
            <div class="bg-light p-30">

                <h4 class="mb-4">Order Summary</h4>

                <table class="table">
                    <tbody>
                        <tr>
                            <th>Order Number</th>
                            <td><%= order.orderNumber %></td>
                        </tr>

                        <tr>
                            <th>Order Date</th>
                            <td><%= order.createdAt.toDateString() %></td>
                        </tr>

                        <!-- Overall Status -->
                        <tr>
                            <th>Status</th>
                            <td>
                                <% let badgeClass = 'secondary'; %>
                                <% if (order.overallStatus === 'pending') badgeClass = 'warning'; %>
                                <% if (order.overallStatus === 'partially_completed') badgeClass = 'info'; %>
                                <% if (order.overallStatus === 'completed') badgeClass = 'success'; %>
                                <% if (order.overallStatus === 'cancelled') badgeClass = 'danger'; %>

                                <span class="badge badge-<%= badgeClass %> rounded-pill px-3 py-2 text-uppercase">
                                    <%= order.overallStatus.replace('_', ' ') %>
                                </span>
                            </td>
                        </tr>

                        <tr>
                            <th>Payment Method</th>
                            <td>
                                <%= order.paymentMethod === 'cod'
                                    ? 'Cash on Delivery'
                                    : 'Online Payment'
                                %>
                            </td>
                        </tr>

                        <tr>
                            <th>Payment Status</th>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 text-uppercase badge-<%= order.paymentStatus === 'paid' ? 'success' : 'warning' %>">
                                    <%= order.paymentStatus %>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <hr>

                <h5>Shipping Address</h5>
                <p class="mb-1"><%= order.shippingAddress.line1 %></p>
                <% if (order.shippingAddress.line2) { %>
                    <p class="mb-1"><%= order.shippingAddress.line2 %></p>
                <% } %>
                <p class="mb-1">
                    <%= order.shippingAddress.city %>,
                    <%= order.shippingAddress.state %>
                </p>
                <p class="mb-1">
                    <%= order.shippingAddress.country %> - <%= order.shippingAddress.postalCode %>
                </p>

            </div>

    <% if ( (order.overallStatus === 'completed' || order.overallStatus === 'partially_completed') && reviewableItems.length ) { %>

    <div class="row my-4">
        <div class="col">
            <div class="bg-light p-3 rounded">
                <h4 class="mb-3">Leave a review</h4>

                <small class="text-muted d-block mb-3">
                    Reviews cannot be edited once submitted.
                </small>

                <form action="/reviews" method="POST">

                    <!-- Product dropdown -->
                    <div class="form-group mb-3">
                        <label for="product">
                            Select Product
                        </label>
                        <select
                            name="productId"
                            id="product"
                            class="form-control"
                            required
                        >
                            <option value="">-- Select a product --</option>
                            <% reviewableItems.forEach(item => { %>
                                <option
                                    value="<%= item.productId %>"
                                    data-shop="<%= item.shopId %>"
                                    data-vendor="<%= item.vendorId %>"
                                >
                                    <%= item.productName %>
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <!-- Rating -->
                    <div class="form-group mb-3">
                        <label>Your Rating</label>
                        <div class="rating-stars text-primary" id="ratingStars">
                            <% for (let i = 5; i >= 1; i--) { %>
                                <i class="far fa-star" data-value="<%= i %>"></i>
                            <% } %>
                        </div>
                        <input type="hidden" name="rating" id="ratingInput" required>
                    </div>

                    <script>
                        const stars = document.querySelectorAll('#ratingStars i');
                        const ratingInput = document.getElementById('ratingInput');
                        let currentRating = 0;

                        stars.forEach(star => {
                            star.addEventListener('mouseover', () => {
                                const value = parseInt(star.dataset.value);
                                highlightStars(value);
                            });

                            star.addEventListener('mouseout', () => {
                                highlightStars(currentRating);
                            });

                            star.addEventListener('click', () => {
                                currentRating = parseInt(star.dataset.value);
                                ratingInput.value = currentRating;
                                highlightStars(currentRating);
                            });
                        });

                        function highlightStars(rating) {
                            stars.forEach(star => {
                                const value = parseInt(star.dataset.value);
                                if (value <= rating) {
                                    star.classList.remove('far'); // empty
                                    star.classList.add('fas');    // solid
                                } else {
                                    star.classList.remove('fas');
                                    star.classList.add('far');
                                }
                            });
                        }
                    </script>


                    <!-- Review -->
                    <div class="form-group mb-3">
                        <label>
                            Your Review
                        </label>
                        <textarea
                            name="comment"
                            rows="4"
                            class="form-control"
                            required
                        ></textarea>
                    </div>

                    <!-- Hidden fields filled by JS -->
                    <input type="hidden" name="shopId" id="shopId">
                    <input type="hidden" name="vendorId" id="vendorId">
                    <input type="hidden" name="orderId" id="orderId" value="<%= order._id %>">

                    <button type="submit" class="btn btn-primary px-4">
                        Submit Review
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const productSelect = document.getElementById('product');
        const shopInput = document.getElementById('shopId');
        const vendorInput = document.getElementById('vendorId');

        productSelect.addEventListener('change', function () {
            const option = this.options[this.selectedIndex];
            shopInput.value = option.dataset.shop || '';
            vendorInput.value = option.dataset.vendor || '';
        });
    </script>

    <% } %>



        </div>

        <!-- RIGHT: VENDOR ORDERS -->
        <div class="col-lg-4">
            <div class="bg-light p-30">
                <% vendorOrders.forEach(vendorOrder => { %>
                    <% let cancelledClass = ''; 
                    cancelledClass = (vendorOrder.vendorStatus == 'cancelled') ? 'alert alert-danger' : '';  %>
                    <div class="border rounded p-3 mb-4 shadow <%= cancelledClass %>">

                        <h6 class="mb-3">
                            <div class="d-flex justify-content-between">
                            <span>Vendor: <a href="<%= '/products?vendor=' + vendorOrder.vendorId.id  %>"><%= vendorOrder.vendorId.name %></a></span>
                            <span class="badge badge-info text-uppercase ml-2">
                                <%= vendorOrder.vendorStatus %>
                            </span>
                            </div>
                        </h6>

                        <% vendorOrder.items.forEach(item => { %>
                            <div class="d-flex justify-content-between">
                                <p><%= item.name %> × <%= item.quantity %></p>
                                <p>$<%= item.subtotal.toFixed(2) %></p>
                            </div>
                        <% }) %>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <strong>Vendor Subtotal</strong>
                            <strong>$<%= vendorOrder.subtotal.toFixed(2) %></strong>
                        </div>

                        <% if (['pending', 'accepted'].includes(vendorOrder.vendorStatus)) { %>
                            <button
                                class="btn btn-danger btn-sm btn-block mt-2"
                                data-toggle="modal"
                                data-target="#cancelVendorOrder<%= vendorOrder._id %>">
                                Cancel Vendor Order
                            </button>

                            <!-- Cancel Vendor Order Modal -->
                            <div class="modal fade" id="cancelVendorOrder<%= vendorOrder._id %>" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <h5 class="modal-title">Cancel Vendor Order?</h5>
                                            <button class="close" data-dismiss="modal">&times;</button>
                                        </div>

                                        <div class="modal-body">
                                            Are you sure you want to cancel this vendor’s items?
                                        </div>

                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <form action="/orders/vendor/cancel/<%= vendorOrder._id %>" method="POST">
                                                <button class="btn btn-danger" type="submit">
                                                    Yes, Cancel
                                                </button>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        <% } %>

                    </div>
                <% }) %>

                <hr>

                <div class="d-flex justify-content-between">
                    <strong>Total Items</strong>
                    <strong><%= order.totalQuantity %></strong>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <h5>Total</h5>
                    <h5>$<%= order.totalPrice.toFixed(2) %></h5>
                </div>

                <hr>

                <% if(order.overallStatus === 'pending') { %>
                <a class="btn btn-danger btn-block" data-toggle="modal" data-target="#cancelOrderModal">Cancel Order</a>
                <% } %>

                <%- include('../partials/cancelOrderModal.ejs') %>

                <a href="/orders" class="btn btn-outline-dark btn-block mt-2">
                    Back to Orders
                </a>

            </div>
        </div>

    </div>
</div>
<!-- /.container-fluid -->