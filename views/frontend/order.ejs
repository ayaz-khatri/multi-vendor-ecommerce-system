<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="/">Home</a>
                <a class="breadcrumb-item text-dark" href="/orders">Orders</a>
                <span class="breadcrumb-item active">Order Details</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->

<div class="container-fluid">
    <div class="row px-xl-5">

        <!-- LEFT: ORDER INFO -->
        <div class="col-lg-8 mb-4">
            <div class="bg-light p-30">

                <h4 class="mb-4">Order Summary</h4>

                <p><strong>Order Number:</strong> <%= order.orderNumber %></p>
                <p><strong>Order Date:</strong> <%= order.createdAt.toDateString() %></p>

                <p>
                    <strong>Status:</strong>
                    <% let badgeClass = 'secondary'; %>
                    <% if (order.overallStatus === 'pending') badgeClass = 'warning'; %>
                    <% if (order.overallStatus === 'partially_completed') badgeClass = 'info'; %>
                    <% if (order.overallStatus === 'completed') badgeClass = 'success'; %>
                    <% if (order.overallStatus === 'cancelled') badgeClass = 'danger'; %>

                    <span class="badge badge-<%= badgeClass %> rounded-pill px-3 py-2 text-uppercase">
                        <%= order.overallStatus.replace('_', ' ') %>
                    </span>
                </p>

                <p>
                    <strong>Payment Method:</strong>
                    <%= order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment' %>
                </p>

                <p>
                    <strong>Payment Status:</strong>
                    <span class="badge rounded-pill px-3 py-2 text-uppercase badge-<%= order.paymentStatus === 'paid' ? 'success' : 'warning' %>">
                        <%= order.paymentStatus %>
                    </span>
                </p>

                <hr>

                <h5>Shipping Address</h5>
                <p class="mb-1"><%= order.shippingAddress.line1 %></p>
                <% if (order.shippingAddress.line2) { %>
                    <p class="mb-1"><%= order.shippingAddress.line2 %></p>
                <% } %>
                <p class="mb-1">
                    <%= order.shippingAddress.city %>,
                    <%= order.shippingAddress.state %>
                </p>
                <p class="mb-1">
                    <%= order.shippingAddress.country %> - <%= order.shippingAddress.postalCode %>
                </p>

            </div>
        </div>

        <!-- RIGHT: VENDOR ORDERS -->
        <div class="col-lg-4">
            <div class="bg-light p-30">
                <% vendorOrders.forEach(vendorOrder => { %>
                    <% let cancelledClass = ''; 
                    cancelledClass = (vendorOrder.vendorStatus == 'cancelled') ? 'alert alert-danger' : '';  %>
                    <div class="border rounded p-3 mb-4 shadow <%= cancelledClass %>">

                        <h6 class="mb-3">
                            <div class="d-flex justify-content-between">
                            <span>Vendor: <a href="<%= '/products?vendor=' + vendorOrder.vendorId.id  %>"><%= vendorOrder.vendorId.name %></a></span>
                            <span class="badge badge-info text-uppercase ml-2">
                                <%= vendorOrder.vendorStatus %>
                            </span>
                            </div>
                        </h6>

                        <% vendorOrder.items.forEach(item => { %>
                            <div class="d-flex justify-content-between">
                                <p><%= item.name %> × <%= item.quantity %></p>
                                <p>$<%= item.subtotal.toFixed(2) %></p>
                            </div>
                        <% }) %>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <strong>Vendor Subtotal</strong>
                            <strong>$<%= vendorOrder.subtotal.toFixed(2) %></strong>
                        </div>

                        <% if (['pending', 'accepted'].includes(vendorOrder.vendorStatus)) { %>
                            <button
                                class="btn btn-danger btn-sm btn-block mt-2"
                                data-toggle="modal"
                                data-target="#cancelVendorOrder<%= vendorOrder._id %>">
                                Cancel Vendor Order
                            </button>

                            <!-- Cancel Vendor Order Modal -->
                            <div class="modal fade" id="cancelVendorOrder<%= vendorOrder._id %>" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">

                                        <div class="modal-header">
                                            <h5 class="modal-title">Cancel Vendor Order?</h5>
                                            <button class="close" data-dismiss="modal">&times;</button>
                                        </div>

                                        <div class="modal-body">
                                            Are you sure you want to cancel this vendor’s items?
                                        </div>

                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            <form action="/orders/vendor/cancel/<%= vendorOrder._id %>" method="POST">
                                                <button class="btn btn-danger" type="submit">
                                                    Yes, Cancel
                                                </button>
                                            </form>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        <% } %>

                    </div>
                <% }) %>

                <hr>

                <div class="d-flex justify-content-between">
                    <strong>Total Items</strong>
                    <strong><%= order.totalQuantity %></strong>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <h5>Total</h5>
                    <h5>$<%= order.totalPrice.toFixed(2) %></h5>
                </div>

                <hr>

                <% if(order.overallStatus === 'pending') { %>
                <a class="btn btn-danger btn-block" data-toggle="modal" data-target="#cancelOrderModal">Cancel Order</a>
                <% } %>

                <%- include('../partials/cancelOrderModal.ejs') %>

                <a href="/orders" class="btn btn-outline-dark btn-block mt-2">
                    Back to Orders
                </a>

            </div>
        </div>

    </div>
</div>
<!-- /.container-fluid -->