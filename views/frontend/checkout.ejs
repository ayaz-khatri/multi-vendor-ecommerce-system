<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="/">Home</a>
                <a class="breadcrumb-item text-dark" href="/products">Products</a>
                <span class="breadcrumb-item active">Checkout</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->


<form id="checkoutForm" action="/orders" method="POST">

<!-- Checkout Start -->
<div class="container-fluid">
    <div class="row px-xl-5">

        <!-- LEFT: SHIPPING ADDRESS -->
        <div class="col-lg-8">
            <h5 class="section-title position-relative text-uppercase mb-3">
                <span class="bg-secondary pr-3">Shipping Address</span>
            </h5>

            <div class="bg-light p-30 mb-5">
                <div class="row">

                    <div class="col-md-6 form-group">
                        <label>Full Name</label>
                        <input class="form-control" type="text" value="<%= authUser.name %>" readonly>
                    </div>

                    <div class="col-md-6 form-group">
                        <label>Email</label>
                        <input class="form-control" type="email" value="<%= authUser.email %>" readonly>
                    </div>

                    <div class="col-md-12 form-group">
                        <label>Address Line 1</label>
                        <input class="form-control" name="shippingAddress[line1]" required>
                    </div>

                    <div class="col-md-12 form-group">
                        <label>Address Line 2</label>
                        <input class="form-control" name="shippingAddress[line2]">
                    </div>

                    <div class="col-md-6 form-group">
                        <label>City</label>
                        <input class="form-control" name="shippingAddress[city]" required>
                    </div>

                    <div class="col-md-6 form-group">
                        <label>State</label>
                        <input class="form-control" name="shippingAddress[state]">
                    </div>

                    <div class="col-md-6 form-group">
                        <label>Country</label>
                        <input class="form-control" name="shippingAddress[country]" required>
                    </div>

                    <div class="col-md-6 form-group">
                        <label>Postal Code</label>
                        <input class="form-control" name="shippingAddress[postalCode]" required>
                    </div>

                </div>
            </div>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="col-lg-4">

            <h5 class="section-title position-relative text-uppercase mb-3">
                <span class="bg-secondary pr-3">Order Summary</span>
            </h5>

            <div class="bg-light p-30 mb-5">

                <% if (cartItems.length === 0) { %>
                    <p>Your cart is empty.</p>
                <% } else { %>

                    <% cartItems.forEach(item => { %>
                        <div class="d-flex justify-content-between">
                            <p>
                                <%= item.productId.name %> × <%= item.quantity %>
                            </p>
                            <p>
                                $<%= (item.productId.price * item.quantity).toFixed(2) %>
                            </p>
                        </div>
                    <% }) %>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <strong>Subtotal</strong>
                        <strong>$<%= cartTotalPrice.toFixed(2) %></strong>
                    </div>

                    <div class="d-flex justify-content-between mt-2">
                        <h5>Total</h5>
                        <h5>$<%= (cartTotalPrice).toFixed(2) %></h5>
                    </div>

                <% } %>
            </div>

            <!-- PAYMENT -->
            <div class="mb-5">
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-secondary pr-3">Payment Method</span>
                </h5>

                <div class="bg-light p-30">

                    <div class="custom-control custom-radio mb-2">
                        <input type="radio" class="custom-control-input" name="paymentMethod" value="cod" id="cod" required>
                        <label class="custom-control-label" for="cod">Cash on Delivery</label>
                    </div>

                    <div class="custom-control custom-radio mb-4">
                        <input type="radio" class="custom-control-input" name="paymentMethod" value="stripe" id="stripe">
                        <label class="custom-control-label" for="stripe">Credit/Debit Card</label>
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert" style="color:red; margin-top:10px;"></div>
                    </div>

                    <input type="submit" class="btn btn-block btn-primary font-weight-bold py-3" value="Place Order">
                </div>
            </div>

        </div>
    </div>
</div>
<!-- Checkout End -->

</form>

<script src="https://js.stripe.com/v3/"></script>

<script>
const stripe = Stripe("<%= stripePublishableKey %>");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

document.getElementById("checkoutForm").addEventListener("submit", async function (e) {
  const paymentMethod = document.querySelector(
    'input[name="paymentMethod"]:checked'
  ).value;

  // ==========================
  // COD → NORMAL FORM SUBMIT
  // ==========================
  if (paymentMethod === "cod") {
    return; // backend placeOrder will handle
  }

  // ==========================
  // STRIPE → INTERCEPT
  // ==========================
  e.preventDefault();

  const shippingAddress = {
    line1: document.querySelector('input[name="shippingAddress[line1]"]').value,
    line2: document.querySelector('input[name="shippingAddress[line2]"]').value,
    city: document.querySelector('input[name="shippingAddress[city]"]').value,
    state: document.querySelector('input[name="shippingAddress[state]"]').value,
    country: document.querySelector('input[name="shippingAddress[country]"]').value,
    postalCode: document.querySelector('input[name="shippingAddress[postalCode]"]').value
  };

  // Create order + PaymentIntent
  const res = await fetch("/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      shippingAddress,
      paymentMethod: "stripe"
    })
  });

  const data = await res.json();

  if (!data.clientSecret) {
    alert("Unable to initiate payment");
    return;
  }

  // Confirm card payment
  const result = await stripe.confirmCardPayment(data.clientSecret, {
    payment_method: { card }
  });

  if (result.error) {
    document.getElementById("card-errors").textContent = result.error.message;
    return;
  }

  // Success → webhook will do the rest
  if (result.paymentIntent.status === "succeeded") {
    window.location.href = `/orders/${data.orderId}`;
  }
});
</script>

