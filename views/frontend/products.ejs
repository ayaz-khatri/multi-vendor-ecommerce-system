<%
    const buildQuery = (params = {}) => {
        return new URLSearchParams({
            ...query,
            ...params
        }).toString();
    };
%>


<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <% breadcrumbs.forEach((item, index) => { %>
                    <% if (item.url) { %>
                        <a class="breadcrumb-item text-dark" href="<%= item.url %>">
                            <%= item.label %>
                        </a>
                    <% } else { %>
                        <span class="breadcrumb-item active">
                            <%= item.label %>
                        </span>
                    <% } %>
                <% }) %>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->



<!-- Products Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <!-- Shop Sidebar Start -->
        <div class="col-lg-3 col-md-4">
            <!-- Price Start -->
            <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Filter by price</span></h5>
            <div class="bg-light p-4 mb-30">
                <form>
                    <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                        <input type="checkbox" class="custom-control-input price-filter" id="price-1" data-min="0" data-max="100">
                        <label class="custom-control-label" for="price-1">$0 - $100</label>
                    </div>
                    <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                        <input type="checkbox" class="custom-control-input price-filter" id="price-2" data-min="100" data-max="200">
                        <label class="custom-control-label" for="price-2">$100 - $200</label>
                    </div>
                    <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                        <input type="checkbox" class="custom-control-input price-filter" id="price-3" data-min="200" data-max="300">
                        <label class="custom-control-label" for="price-3">$200 - $300</label>
                    </div>
                    <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between mb-3">
                        <input type="checkbox" class="custom-control-input price-filter" id="price-4" data-min="300" data-max="400">
                        <label class="custom-control-label" for="price-4">$300 - $400</label>
                    </div>
                    <div class="custom-control custom-checkbox d-flex align-items-center justify-content-between">
                        <input type="checkbox" class="custom-control-input price-filter" id="price-5" data-min="400" data-max="500">
                        <label class="custom-control-label" for="price-5">$400 - $500</label>
                    </div>
                </form>
            </div>
            <!-- Price End -->

        </div>
        <!-- Shop Sidebar End -->


        <!-- Shop Product Start -->
        <div class="col-lg-9 col-md-8">
            <div class="row pb-3">
                <div class="col-12 pb-1">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div>
                            <!-- <button class="btn btn-sm btn-light"><i class="fa fa-th-large"></i></button>
                            <button class="btn btn-sm btn-light ml-2"><i class="fa fa-bars"></i></button> -->
                        </div>
                        <div class="ml-2">
                            <div class="btn-group ml-2">
                                <a href="/products" type="button" class="btn btn-sm btn-light">Clear Filters</a>
                            </div>
                            <div class="btn-group ml-2">
                                <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-toggle="dropdown">Sorting</button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="?<%= buildQuery({ sort: 'price_asc', page: 1 }) %>">
                                        Price (Low to High)
                                    </a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ sort: 'price_desc', page: 1 }) %>">
                                        Price (High to Low)
                                    </a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ sort: 'name', page: 1 }) %>">
                                        Name
                                    </a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ sort: 'latest', page: 1 }) %>">
                                        Latest
                                    </a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ sort: 'rating', page: 1 }) %>">
                                        Best Rating
                                    </a>
                                </div>
                            </div>
                            <div class="btn-group ml-2">
                                <button type="button" class="btn btn-sm btn-light dropdown-toggle" data-toggle="dropdown">Showing</button>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a class="dropdown-item" href="?<%= buildQuery({ limit: 3, page: 1 }) %>">3</a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ limit: 10, page: 1 }) %>">10</a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ limit: 20, page: 1 }) %>">20</a>
                                    <a class="dropdown-item" href="?<%= buildQuery({ limit: 50, page: 1 }) %>">50</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% if (totalDocs === 0) { %>
                    <div class="alert alert-warning my-4 w-100">
                        <%= message %>
                    </div>
                <% } else { %>
                <% products.forEach(product => { %>
                <div class="col-lg-4 col-md-6 col-sm-6 pb-1">
                    <div class="product-item bg-light mb-4 shadow">
                        <div class="product-img position-relative overflow-hidden">
                            <img class="img-fluid w-100" src="<%= (product.images[0] && product.images[0].url) ? product.images[0].url : '/img/placeholder.png' %>" alt="<%= product.name %>">
                            <div class="product-action">
                                <a class="btn btn-outline-dark btn-square" href="/products/<%= product.slug %>"><i class="fa fa-eye"></i></a>
                                <a
                                    class="btn btn-outline-dark btn-square cart-btn"
                                    data-toggle="modal"
                                    data-target="#cartModal"
                                    data-product="<%= product._id %>"
                                    data-added="<%= cartProductIds.includes(product._id.toString()) ? '1' : '0' %>"
                                    type="button"
                                    >
                                    <i class="fa fa-shopping-cart <%= cartProductIds.includes(product._id.toString()) ? 'text-info' : '' %>"></i>
                                </a>
                                <a
                                    class="btn btn-outline-dark btn-square wishlist-btn"
                                    data-toggle="modal"
                                    data-target="#wishlistModal"
                                    data-product="<%= product._id %>"
                                    data-shop="<%= product.shopId._id %>"
                                    data-vendor="<%= product.vendorId._id %>"
                                    data-added="<%= wishlistIds?.includes(product._id.toString()) ? '1' : '0' %>"
                                    type="button"
                                    >
                                        <i class="<%= wishlistIds?.includes(product._id.toString()) ? 'fas fa-heart text-info' : 'far fa-heart' %>"></i>
                                </a>
                            </div>
                        </div>
                        <div class="text-center py-4">
                            <a class="h6 text-decoration-none text-truncate" href="/products/<%= product.slug %>"><%= product.name %></a>
                            <div class="d-flex align-items-center justify-content-center mt-2">
                                <h5>$<%= product.price %></h5><h6 class="text-muted ml-2"><del>$<%= product.price * 2 %></del></h6>
                            </div>
                            <% if(product.stock > 0) { %>
                                <small class="text-success">In Stock</small>
                            <% } else { %>
                                <small class="text-danger">Out of Stock</small>
                            <% } %>
                            <div class="d-flex align-items-center justify-content-center mb-1">
                                <% 
                                    const fullStars = Math.floor(product.avgRating); // Number of full stars
                                    const halfStar = product.avgRating - fullStars >= 0.5; // Half star if needed
                                    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0); // Remaining empty stars
                                %>

                                <% for(let i = 0; i < fullStars; i++) { %>
                                    <small class="fas fa-star text-primary mr-1"></small>
                                <% } %>

                                <% if (halfStar) { %>
                                    <small class="fas fa-star-half-alt text-primary mr-1"></small>
                                <% } %>

                                <% for(let i = 0; i < emptyStars; i++) { %>
                                    <small class="far fa-star text-primary mr-1"></small>
                                <% } %>

                                <small>(<%= product.reviewCount %>)</small>
                            </div>

                        </div>
                        <div class="row bg-dark m-0">
                            <div class="col text-left">
                                <small><a class="text-decoration-none" href="/categories/<%= product.categoryId.slug %>"><%= product.categoryId.name %></a></small>
                            </div>
                            <div class="col text-right text-secondary">
                                <small><a class="text-decoration-none" href="/shops/<%= product.shopId.slug %>"><%= product.shopId.name %></a></small>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>

                <div class="col-12">

                    <nav>
                        <ul class="pagination justify-content-end">

                            <!-- Previous -->
                            <li class="page-item <%= !hasPrevPage ? 'disabled' : '' %>">
                                <% if (hasPrevPage) { %>
                                    <a class="page-link" href="?<%= buildQuery({ page: prevPage }) %>">
                                        Previous
                                    </a>
                                <% } else { %>
                                    <span class="page-link">Previous</span>
                                <% } %>
                            </li>

                            <!-- Page Numbers -->
                            <% for (let i = 1; i <= totalPages; i++) { %>
                                <li class="page-item <%= page === i ? 'active' : '' %>">
                                    <a class="page-link text-dark" href="?<%= buildQuery({ page: i }) %>">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>

                            <!-- Next -->
                            <li class="page-item <%= !hasNextPage ? 'disabled' : '' %>">
                                <% if (hasNextPage) { %>
                                    <a class="page-link" href="?<%= buildQuery({ page: nextPage }) %>">
                                        Next
                                    </a>
                                <% } else { %>
                                    <span class="page-link">Next</span>
                                <% } %>
                            </li>

                        </ul>
                    </nav>

                </div>
                <% } %>
            </div>
        </div>
        <!-- Product End -->
    </div>
</div>
<!-- Products End -->

<script>
const priceCheckboxes = document.querySelectorAll('.price-filter');

document.addEventListener("DOMContentLoaded", function () {
    const params = new URLSearchParams(window.location.search);
    const min = params.get("min");
    const max = params.get("max");

    const checkboxes = document.querySelectorAll(".price-filter");

    let matched = false;

    checkboxes.forEach(cb => {
        if (
            cb.dataset.min === min &&
            cb.dataset.max === max
        ) {
            cb.checked = true;
            matched = true;
        } else {
            cb.checked = false;
        }
    });

    // If no range matched → select "All Price"
    if (!matched) {
        document.getElementById("price-all").checked = true;
    }
});

priceCheckboxes.forEach(cb => {
    cb.addEventListener('change', function () {

        if (!this.checked) return;

        // Allow only one checkbox
        priceCheckboxes.forEach(other => {
            if (other !== this) other.checked = false;
        });

        const min = this.dataset.min;
        const max = this.dataset.max;

        // Preserve existing query params
        const url = new URL(window.location.href);
        const params = url.searchParams;

        if (min !== "" && max !== "") {
            params.set("min", min);
            params.set("max", max);
            params.delete("page"); // reset pagination
        } else {
            // All Price → remove price filter
            params.delete("min");
            params.delete("max");
            params.delete("page");
        }

        window.location.href = url.toString();
    });
});
</script>


